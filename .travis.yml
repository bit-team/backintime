# TravisCI (https://travis-ci.org) configuration file
# https://docs.travis-ci.com/user/languages/python

# Note about PyQt related unit tests:
# They are not executed on architecture "ppc64le". For this architecture
# PyQt is not available from PyPi and not installable via pip.
# The alternative to use "system-site-packages" option and installing PyQt5
# from Ubuntu repository via "apt" is not working as expected. TravisCI
# allow "system-site-packages" only for those Python interpreteres that are
# offered by Ubuntu itself; Python 3.8 in case of Ubuntu Focal. Other Python
# versions are installed from other sources into a virtual environment and
# not allowed to use packages installed via "apt".

language: python

os: linux
 
arch:
 - amd64
 - ppc64le

# ensures that we have UUID filesystem mounts for proper testing
dist: focal

# python:
#   - "3.8"
#   - "3.9"
#   - "3.10"
#   - "3.11"
# #   - "3.12"
 
jobs:
  include:
    - python: 3.8
      env: SYSTEM_SITE_PACKAGES=true
    - python: [3.9, 3.10, 3.11]

# env:
#     # TravisCI support said this could prevent errors from "make".
#     PYTHONUNBUFFERED=1
#     - python: "3.8"
#       env: SYSTEM_SITE_PACKAGES=true

addons:
  # add localhost to known_hosts to prevent ssh unknown host prompt during unit tests
  ssh_known_hosts: localhost

  

# virtualenv:
#   # Packages installed via "apt" are available to Pythons virtenv.
#   # Necessary because PyQt is installed via "apt". Install via "pip" is
#   # not possible because PyPi do not offer a build for "ppc64le" architecture.
#   system_site_packages: true
  
before_install:
  # disable mongodb as we don't need it and it sometimes temporary fails
  # https://github.com/travis-ci/travis-ci/issues/4937#issuecomment-149289729
  - sudo rm -f /etc/apt/sources.list.d/mongodb.list
  - sudo apt-get -qq update
  # install screen, and util-linux (provides flock) for test_sshtools
  - sudo apt-get install -y sshfs screen util-linux

# jobs:
#   include:
#     - python: "3.8"
#       env: SYSTEM_SITE_PACKAGES=true
# #   exclude:
# #     - python: "3.9"
# #     - python: "3.10"
# #     - python: "3.11"
# #     # Excluding this temporarily because of an Issue on Travis. Support contact established.
# #     - arch: ppc64le
# #       python: "3.12"

install:
  - pip install pylint coveralls pyfakefs
  # PyQt5 is not available for "ppc64le" architecture on PyPi
  - if [ "$TRAVIS_ARCH" != "ppc64le" ] ; then pip install pyqt5; fi
  - if [ "$TRAVIS_ARCH" == "ppc64le" ] ; then sudo apt install -y python3-pyqt5; fi
  # add ssh public / private key pair to ensure user can start ssh session to localhost for tests
  - ssh-keygen -b 2048 -t rsa -f /home/travis/.ssh/id_rsa -N ""
  - cat ~/.ssh/id_rsa.pub >> ~/.ssh/authorized_keys
  # start ssh-agent so that we can add private keys
  - eval `ssh-agent -s`

script:
  # - coverage debug sys
  # compile all files - ensure that syntax is correct
  - python -m compileall common common/test common/plugins qt qt/test qt/plugins
  # run unit tests - ensure that functionality is correct
  - cd common
  - ./configure  --python=python3
  - make unittest-v
  - cd ..
  - cd qt
  - ./configure --python=python3
  - make
  # PyQt5 is not installed on "ppc64le"
  # - if [ "$TRAVIS_ARCH" != "ppc64le" ] ; then pytest; fi
  - pytest

after_success:
  - coverage combine
  - coveralls
